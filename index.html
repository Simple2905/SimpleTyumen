<script>
  // ...остальной код оставь как есть

  async function sendOrder(){
    const payload = buildPayload();
    if (!payload.items.length) return alert("Корзина пуста");

    const method   = document.getElementById('deliveryMethod').value;
    const pickupEl = document.getElementById('pickupPoint');
    const zoneEl   = document.getElementById('zone');

    const fee   = calcDelivery(payload.total);
    const total = payload.total + fee;

    const form = {
      deliveryMethod: method,
      pickupPoint: pickupEl.value,
      zone: zoneEl.value,
      address: document.getElementById('address').value.trim(),
      date: document.getElementById('date').value,
      time: document.getElementById('time').value,
      name: document.getElementById('name').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      comment: document.getElementById('comment').value.trim(),
    };

    if (!form.phone) return alert("Укажите телефон");
    if (!form.name)  return alert("Укажите имя");

    // Сформировать items как в Postman: name/price/qty (price строкой с " ₽")
    const items = payload.items.map(i => ({
      name: i.title,
      price: i.price.toLocaleString('ru-RU') + ' ₽',
      qty: i.qty
    }));

    // Итоговый JSON 1-в-1 как в твоём curl
    const body = {
      name:   form.name,
      phone:  form.phone,
      address: form.address,
      comment: form.comment,
      deliveryMethod: form.deliveryMethod,       // "pickup" | "delivery"
      pickupPoint: form.pickupPoint,             // "polevaya" | "burlaki"
      zone: form.zone,                           // "city" | "suburb" | "far"
      date: form.date,                           // "YYYY-MM-DD"
      time: form.time,                           // "HH:mm"
      items,                                     // [{ name, price: "2 200 ₽", qty }]
      source: 'Мини-приложение',
      total: payload.total,                      // сумма товаров
      fee,                                       // доставка
      timePlaced: new Date().toISOString()
    };

    try {
      // URL — выбери ОДИН из вариантов и используй везде одинаково:

      // Вариант A: идти через редирект /api/sendOrder (если в _redirects: /api/sendOrder -> /.netlify/functions/sendOrder)
      const url = '/api/sendOrder';

      // Вариант B (напрямую, без редиректа):
      // const url = '/.netlify/functions/sendOrder';

      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      // На время отладки оставим логи:
      console.log('[sendOrder] request body:', body);
      const json = await resp.json().catch(()=> ({}));
      console.log('[sendOrder] response:', resp.status, json);

      if (resp.ok && json.ok) {
        alert('Заказ отправлен! Мы свяжемся с вами для подтверждения.');
        for (const k in cart) delete cart[k];
        save(); updateMainButton(); showCatalog();
      } else {
        alert('Не удалось отправить заказ. Пожалуйста, попробуйте ещё раз.');
      }
    } catch (e) {
      console.error(e);
      alert('Сбой отправки. Попробуйте ещё раз или свяжитесь с нами в Telegram.');
    }
  }

  // ...остальной код оставь как есть
</script>
