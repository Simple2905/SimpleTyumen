<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–æ–ª–ª–µ–∫—Ü–∏—è –∫ 1 —Å–µ–Ω—Ç—è–±—Ä—è</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã (Suggest + Geocode) -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=41cc1bdf-35fa-4959-ae88-6493220031f0&lang=ru_RU&suggest_apikey=41cc1bdf-35fa-4959-ae88-6493220031f0" type="text/javascript"></script>

  <style>
    :root { --pad:16px; --brand:#6b8f52; --muted:#e2e5ea; --shadow:0 8px 24px rgba(0,0,0,.08); }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Arial,Segoe UI,Roboto,sans-serif;background:#f6f7fb;color:#111}
    header{position:sticky;top:0;background:#fff;z-index:30;box-shadow:var(--shadow)}
    .strip{padding:10px var(--pad);text-align:center;font-weight:700;color:#fff;
           background:linear-gradient(90deg,#ef4444,#f97316,#f59e0b,#22c55e,#3b82f6,#8b5cf6);
           background-size:200% 100%; animation:slide 12s linear infinite;}
    @keyframes slide{0%{background-position:0% 0}100%{background-position:100% 0}}
    .head{display:flex;justify-content:space-between;align-items:center;padding:8px var(--pad);}
    .sub{font-weight:500;opacity:.9}
    .timer{font-size:14px;color:#d32f2f;font-weight:700}
    .wrap{max-width:1024px;margin:0 auto;padding:var(--pad)}
    .view{display:none} .view.active{display:block}
    .sort{display:flex;justify-content:flex-end;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    select,input,textarea{padding:10px;border:1px solid var(--muted);border-radius:10px;width:100%}
    .ghost{background:#fff;border:1px solid var(--muted);color:#111;border-radius:12px;padding:10px 12px;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
    @media(min-width:740px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{background:#fff;border-radius:20px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column;animation:fadeInUp .45s ease both}
    .imgbox{position:relative;aspect-ratio:3/4;background:#eee;overflow:hidden}
    .imgbox img{width:100%;height:100%;object-fit:cover;object-position:center top;display:block}
    .info{padding:12px}
    .title{font-weight:600;margin:0 0 6px;line-height:1.25}
    .price{font-size:15px;margin-bottom:10px;opacity:.9}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{flex:1;padding:12px;border-radius:12px;border:none;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
    .pill{padding:6px 10px;border-radius:999px;background:#f0f2f6;font-size:12px;margin-left:6px}
    footer{text-align:center;color:#777;padding:40px 0}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

    .checkout-card{background:#fff;border-radius:20px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;justify-content:space-between;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap}
    .field{flex:1;min-width:200px;display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .note{font-size:12px;color:#666}
    .muted{color:#666;font-size:14px}
    .total{font-weight:700;font-size:18px}
    .qtyline{display:flex;gap:8px;align-items:center}
    .qbtn{width:28px;height:28px;border-radius:8px;border:1px solid var(--muted);background:#fff;cursor:pointer}
    .count{width:24px;text-align:center;display:inline-block}
    .hidden{display:none}

    /* –ö—Ä—É–ø–Ω–µ–µ ¬´–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è¬ª –∏ ¬´–¢–æ—á–∫–∞ —Å–∞–º–æ–≤—ã–≤–æ–∑–∞¬ª */
    #deliveryWrap label, #pickupWrap label{ font-size:18px; font-weight:700; line-height:1.3; }
    #deliveryMethod, #pickupPoint{
      font-size:18px; padding:14px 16px; min-height:48px; border-radius:12px;
    }
    #deliveryMethod:focus, #pickupPoint:focus{
      outline:none; box-shadow:0 0 0 3px rgba(107,143,82,.2); border-color:#6b8f52;
    }

    /* FAB –∫–æ—Ä–∑–∏–Ω–∞ */
    #fabCart{
      position: fixed; right: 16px; bottom: 16px; z-index: 1000;
      display: none; align-items: center; padding: 12px 16px;
      border: none; border-radius: 999px; background: var(--brand); color: #fff;
      font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,.15); cursor: pointer; font-size: 14px;
    }
    #fabCart .sep{opacity:.7;margin:0 8px;}

    /* === –ê–Ω–∏–º–∞—Ü–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã === */
    /* –ø–æ–ª—ë—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É */
    .fly-clone{
      position: fixed; z-index: 2000; pointer-events: none; border-radius: 12px;
      width: 120px; height: 160px; object-fit: cover; box-shadow: var(--shadow);
      transition: transform .6s cubic-bezier(.2,.8,.2,1), opacity .6s ease;
    }
    /* –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ */
    .cart-row{opacity:0; transform: translateY(6px); transition: opacity .25s ease, transform .25s ease;}
    .cart-row.enter{opacity:1; transform: translateY(0);}
    /* –ø–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ */
    .cart-row.removing{opacity:0; transform: translateY(-6px);}
    /* –º–∏–Ω–∏–∞—Ç—é—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ */
    .thumb{
      width:44px; height:60px; object-fit:cover; border-radius:8px; margin-right:8px;
      flex-shrink:0; background:#eee;
    }
    .cart-title{display:flex; align-items:center; gap:8px;}
  </style>
</head>
<body>
  <header>
    <div class="strip">–ö–æ–ª–ª–µ–∫—Ü–∏—è –∫ 1 —Å–µ–Ω—Ç—è–±—Ä—è</div>
    <div class="head">
      <div class="sub">–î–∞—Ä–∏—Ç—å —Ü–≤–µ—Ç—ã ‚Äî –ø—Ä–æ—Å—Ç–æ üå∏</div>
      <div id="timer" class="timer"></div>
    </div>
  </header>

  <div class="wrap">
    <!-- CATALOG -->
    <section id="view-catalog" class="view active">
      <div class="sort">
        <label for="sortSel">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
        <select id="sortSel">
          <option value="default">–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
          <option value="asc">—Ü–µ–Ω–∞ ‚Üë</option>
          <option value="desc">—Ü–µ–Ω–∞ ‚Üì</option>
        </select>
        <button id="goCheckout" class="ghost">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
      </div>
      <div id="grid" class="grid"></div>
    </section>

    <!-- CHECKOUT -->
    <section id="view-checkout" class="view">
      <div class="checkout-card">
        <div class="row">
          <div><b>–í–∞—à –∑–∞–∫–∞–∑</b> <span class="pill" id="cartCount">0 —Ç–æ–≤–∞—Ä–æ–≤</span></div>
          <button id="backToCatalog" class="ghost" style="min-width:120px">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="orderList" class="muted"></div>

        <div class="row"><b>–ó–∞–∫–∞–∑—á–∏–∫</b></div>
        <div class="row">
          <div class="field"><label>–ò–º—è</label><input id="customerName" autocomplete="name" /></div>
          <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="customerPhone" inputmode="tel" autocomplete="tel" /></div>
        </div>

        <div class="field">
          <label><input type="checkbox" id="samePerson" /> –ü–æ–ª—É—á–∞—Ç–µ–ª—å = –ó–∞–∫–∞–∑—á–∏–∫</label>
        </div>

        <div id="recipientFields">
          <div class="row"><b>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</b></div>
          <div class="row">
            <div class="field"><label>–ò–º—è</label><input id="recipientName" /></div>
            <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="recipientPhone" inputmode="tel" /></div>
          </div>
        </div>

        <div class="field" id="deliveryWrap">
          <label>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</label>
          <select id="deliveryMethod">
            <option value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑</option>
            <option value="delivery">–î–æ—Å—Ç–∞–≤–∫–∞</option>
          </select>
        </div>

        <div id="pickupWrap" class="field">
          <label>–¢–æ—á–∫–∞ —Å–∞–º–æ–≤—ã–≤–æ–∑–∞</label>
          <select id="pickupPoint">
            <option value="polevaya">–ü–æ–ª–µ–≤–∞—è, 109—Å9</option>
            <option value="burlaki">–ë—É—Ä–ª–∞–∫–∏, 2–∞–∫3</option>
          </select>
        </div>

        <div id="addrWrap" class="field hidden">
          <label>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
          <input id="address" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å..." />
          <div class="note">–î–æ–ø—É—Å—Ç–∏–º—ã –∞–¥—Ä–µ—Å–∞ —Ç–æ–ª—å–∫–æ –≤ –≥. –¢—é–º–µ–Ω–∏ –∏–ª–∏ –¢—é–º–µ–Ω—Å–∫–æ–º —Ä–∞–π–æ–Ω–µ.</div>
        </div>

        <div class="row">
          <div class="field"><label>–î–∞—Ç–∞</label><input id="date" type="date" /></div>
          <div class="field">
            <label>–í—Ä–µ–º–µ–Ω–Ω–æ–π —Å–ª–æ—Ç (1 —á–∞—Å)</label>
            <select id="timeSlot"></select>
          </div>
        </div>

        <div class="field"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea id="comment" rows="3" placeholder="–û—Ç–∫—Ä—ã—Ç–∫–∞, –¥–æ–º–æ—Ñ–æ–Ω, –ø–æ–∂–µ–ª–∞–Ω–∏—è..."></textarea></div>

        <div class="row">
          <div class="total">
            –¢–æ–≤–∞—Ä—ã: <span id="subtotalText">0 ‚ÇΩ</span><br>
            –î–æ—Å—Ç–∞–≤–∫–∞: <span id="feeText">0 ‚ÇΩ</span><br>
            <span class="note" id="freeNote"></span><br>
            –ò—Ç–æ–≥–æ: <span id="totalText">0 ‚ÇΩ</span>
          </div>
          <button id="sendOrder" class="btn" style="min-width:200px">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
      </div>
    </section>

    <footer>üïò –ü–Ω‚Äì–í—Å 08:30‚Äì21:00 ‚Ä¢ üõµ –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –¢—é–º–µ–Ω–∏</footer>
  </div>

  <!-- FAB –∫–æ—Ä–∑–∏–Ω—ã -->
  <button id="fabCart" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É">
    üõí <span id="fabCount">0</span><span class="sep">¬∑</span><span id="fabTotal">0 ‚ÇΩ</span>
  </button>

<script>
/* ====== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ====== */
const DELIVERY = { byZone: { city: 200, suburb: 350, far: 500 }, freeFrom: 4000, defaultZone: 'city' };
const SLOT_WINDOWS = {
  delivery: { startMin: 9*60+30, endMin: 21*60+30 }, // 09:30‚Äì21:30
  pickup:   { startMin: 8*60+30, endMin: 21*60    }  // 08:30‚Äì21:00
};

let PRODUCTS = [];
fetch('./products.json').then(r => r.json()).then(list => { PRODUCTS = list; init(); })
  .catch(_ => { PRODUCTS = []; init(); });

const tg = window.Telegram?.WebApp; if (tg) tg.expand();
const cart = JSON.parse(sessionStorage.getItem('cart')||'{}');
function save(){ sessionStorage.setItem('cart', JSON.stringify(cart)); }
function formatPrice(n){ return n.toLocaleString('ru-RU') + ' ‚ÇΩ'; }

/* ====== –Ø–Ω–¥–µ–∫—Å: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞ ====== */
let addressValid = false;
let lastGeocodedAddress = "";
function geocodeValidate(address){
  return new Promise((resolve)=>{
    if (!window.ymaps || !address) return resolve(false);
    ymaps.geocode(address, { results: 1 }).then(res=>{
      if (res.geoObjects.getLength() > 0){
        const obj = res.geoObjects.get(0);
        const line = obj.getAddressLine && obj.getAddressLine() ? obj.getAddressLine() : address;
        const parts = (obj.getLocalities?.()||[]).join(' ') + " " + (obj.getAdministrativeAreas?.()||[]).join(' ');
        const allowed = /–¢—é–º–µ–Ω—å/i.test(parts) || /–¢—é–º–µ–Ω—Å–∫/i.test(parts);
        if (allowed){ lastGeocodedAddress = line; return resolve(true); }
      }
      resolve(false);
    }).catch(()=> resolve(false));
  });
}

/* ====== –¢–µ–ª–µ—Ñ–æ–Ω: –º–∞—Å–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è ====== */
function applyPhoneMask(el){
  function onlyDigits(s){ return s.replace(/\D/g,''); }
  el.addEventListener('input', ()=>{
    let d = onlyDigits(el.value);
    if (d.startsWith('8')) d = '7'+d.slice(1);
    if (!d.startsWith('7')) d = '7' + d;
    d = d.slice(0,11);
    let out = '+7';
    if (d.length>1) out += ' (' + d.slice(1,4);
    if (d.length>=4) out += ') ' + d.slice(4,7);
    if (d.length>=7) out += '-' + d.slice(7,9);
    if (d.length>=9) out += '-' + d.slice(9,11);
    el.value = out;
  });
}
function isPhoneValid(masked){
  const digits = masked.replace(/\D/g,'');
  return digits.length===11 && digits.startsWith('7');
}
function phoneDigits(masked){ return masked.replace(/\D/g,''); }

/* ====== –°–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ ====== */
function minutesToHHMM(mins){ const h=String(Math.floor(mins/60)).padStart(2,'0'); const m=String(mins%60).padStart(2,'0'); return `${h}:${m}`; }
function generateHourSlots(dateStr, method){
  const { startMin, endMin } = SLOT_WINDOWS[method];
  const now = new Date();
  const minStartTs = new Date(now.getTime()+2*60*60*1000); // +2 —á–∞—Å–∞
  const day = new Date(dateStr + 'T00:00:00');

  const slots = [];
  for (let m = startMin; m+60 <= endMin; m += 60){
    const from = minutesToHHMM(m);
    const to   = minutesToHHMM(m+60);
    const slotStart = new Date(`${dateStr}T${from}:00`);
    if (day > new Date(now.getFullYear(), now.getMonth(), now.getDate()) || slotStart >= minStartTs){
      slots.push({value: from, label: `${from}‚Äì${to}`});
    }
  }
  return slots;
}
function ensureDateHasSlots(method){
  const dateEl = document.getElementById('date');
  const timeEl = document.getElementById('timeSlot');
  let d = dateEl.value;
  if (!d){
    const today = new Date();
    d = today.toISOString().slice(0,10);
    dateEl.value = d;
  }
  let slots = generateHourSlots(d, method);
  if (slots.length===0){
    const dt = new Date(d+'T00:00:00'); dt.setDate(dt.getDate()+1);
    d = dt.toISOString().slice(0,10);
    dateEl.value = d;
    slots = generateHourSlots(d, method);
  }
  timeEl.innerHTML = slots.map(s=>`<option value="${s.value}">${s.label}</option>`).join('');
}

/* ====== –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–ª—ë—Ç–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É ====== */
function flyToCart(imgEl){
  const fab = document.getElementById('fabCart');
  if (!imgEl || !fab) return;
  const imgRect = imgEl.getBoundingClientRect();
  const fabRect = fab.getBoundingClientRect();

  const clone = imgEl.cloneNode(true);
  clone.classList.add('fly-clone');
  clone.style.left = imgRect.left + 'px';
  clone.style.top  = imgRect.top  + 'px';
  clone.style.width = imgRect.width + 'px';
  clone.style.height = imgRect.height + 'px';
  document.body.appendChild(clone);

  const dx = (fabRect.left + fabRect.width/2) - (imgRect.left + imgRect.width/2);
  const dy = (fabRect.top  + fabRect.height/2) - (imgRect.top  + imgRect.height/2);

  requestAnimationFrame(()=>{
    clone.style.transform = `translate(${dx}px, ${dy}px) scale(.25)`;
    clone.style.opacity = '0.2';
  });
  setTimeout(()=> clone.remove(), 650);
}

/* ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====== */
function init(){
  // –∫–Ω–æ–ø–∫–∏
  document.getElementById('goCheckout').addEventListener('click', e=>{ e.preventDefault(); showCheckout(); });
  document.getElementById('backToCatalog').onclick = showCatalog;
  document.getElementById('sendOrder').onclick = sendOrder;
  document.getElementById('sortSel').addEventListener('change', renderCatalog);
  document.getElementById('fabCart').addEventListener('click', showCheckout);

  // Telegram MainButton ‚Üí –æ—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É
  if (tg) tg.onEvent('mainButtonClicked', showCheckout);

  // —á–µ–∫–±–æ–∫—Å ¬´–ø–æ–ª—É—á–∞—Ç–µ–ª—å = –∑–∞–∫–∞–∑—á–∏–∫¬ª
  document.getElementById('samePerson').addEventListener('change', e=>{
    const hide = e.target.checked;
    document.getElementById('recipientFields').style.display = hide ? 'none' : 'block';
    if (hide){
      document.getElementById('recipientName').value  = document.getElementById('customerName').value;
      document.getElementById('recipientPhone').value = document.getElementById('customerPhone').value;
    }
  });

  // –Ø–Ω–¥–µ–∫—Å-–ø–æ–¥—Å–∫–∞–∑–∫–∏
  if (window.ymaps) {
    ymaps.ready(()=>{
      const suggest = new ymaps.SuggestView('address');
      suggest.events.add('select', async (e)=>{
        const val = e.get('item')?.value || document.getElementById('address').value;
        addressValid = await geocodeValidate(val);
        if (addressValid) document.getElementById('address').value = lastGeocodedAddress || val;
      });
    });
  }
  document.getElementById('address').addEventListener('input', ()=>{ addressValid=false; });

  // –º–∞—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
  applyPhoneMask(document.getElementById('customerPhone'));
  applyPhoneMask(document.getElementById('recipientPhone'));

  // –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑—á–∏–∫–∞
  const LS_KEY = 'simpetyumen_customer';
  const saved = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
  if (saved.name)  document.getElementById('customerName').value  = saved.name;
  if (saved.phone) document.getElementById('customerPhone').value = saved.phone;
  ['customerName','customerPhone'].forEach(id=>{
    document.getElementById(id).addEventListener('input', ()=>{
      localStorage.setItem(LS_KEY, JSON.stringify({
        name:  document.getElementById('customerName').value.trim(),
        phone: document.getElementById('customerPhone').value.trim()
      }));
    });
  });

  // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–∞ ‚Üí –∞–¥—Ä–µ—Å + —Å–ª–æ—Ç—ã
  const methodSel = document.getElementById('deliveryMethod');
  const addrWrap  = document.getElementById('addrWrap');
  methodSel.addEventListener('change', ()=>{
    if (methodSel.value === 'delivery') addrWrap.classList.remove('hidden');
    else addrWrap.classList.add('hidden');
    ensureDateHasSlots(methodSel.value);
    renderCheckout();
  });

  // –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã ‚Üí —Å–ª–æ—Ç—ã
  document.getElementById('date').addEventListener('change', ()=>{
    ensureDateHasSlots(methodSel.value);
  });

  // –¥–µ—Ñ–æ–ª—Ç—ã
  const today = new Date(); document.getElementById('date').value = today.toISOString().slice(0,10);
  ensureDateHasSlots(methodSel.value);

  renderCatalog();
  renderCheckout();
  updateCartUI();
}

/* ====== –†–µ–Ω–¥–µ—Ä –∫–∞—Ç–∞–ª–æ–≥–∞ / –∫–æ—Ä–∑–∏–Ω—ã ====== */
function renderCatalog(){
  const grid = document.getElementById('grid');
  let list = PRODUCTS.slice();
  const sortSel = document.getElementById('sortSel')?.value || 'default';
  list.sort((a,b)=>{
    const pa = Number(a.price.toString().replace(/\D/g,''))||0;
    const pb = Number(b.price.toString().replace(/\D/g,''))||0;
    if (sortSel==='asc') return pa-pb;
    if (sortSel==='desc') return pb-pa;
    return 0;
  });

  grid.innerHTML = '';
  list.forEach(p=>{
    const qty = cart[p.id]||0;
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <div class="imgbox"><img src="./images/${p.img}" alt="" loading="lazy"></div>
      <div class="info">
        <div class="title">${p.title}</div>
        <div class="price">${formatPrice(Number(p.price.toString().replace(/\D/g,'')))}</div>
        <div class="controls"><button class="btn add" data-id="${p.id}">–í –∫–æ—Ä–∑–∏–Ω—É ${qty>0?`<span class="pill">${qty}</span>`:''}</button></div>
      </div>`;

    const imgEl = el.querySelector('.imgbox img');

    el.querySelector('.add').onclick = e=>{
      const id=e.currentTarget.dataset.id;
      cart[id]=(cart[id]||0)+1;
      save();
      // –ø–æ–ª—ë—Ç –∫ FAB
      flyToCart(imgEl);
      renderCatalog();
      if (document.getElementById('view-checkout').classList.contains('active')) renderCheckout();
      updateCartUI();
    };
    grid.appendChild(el);
  });
}

function buildPayload(){
  const items = Object.entries(cart).map(([id,qty])=>{
    const p = PRODUCTS.find(x=>x.id===id);
    const priceNum = Number(p.price.toString().replace(/\D/g,''))||0;
    return {id,title:p.title,price:priceNum,qty,amount:priceNum*qty,img:p.img};
  });
  const total = items.reduce((s,i)=>s+i.amount,0);
  return {items,total};
}

function calcDelivery(subtotal){
  const method = document.getElementById('deliveryMethod').value;
  if (method==='pickup') return 0;
  if (subtotal >= DELIVERY.freeFrom) return 0;
  return DELIVERY.byZone.city;
}

function renderCheckout(){
  const payload = buildPayload();
  document.getElementById('cartCount').textContent = payload.items.length+" —Ç–æ–≤–∞—Ä(–∞)";

  const listEl=document.getElementById('orderList');
  listEl.innerHTML=payload.items.map(i=>`
    <div class="row cart-row" data-id="${i.id}">
      <div class="cart-title" style="flex:1">
        <img class="thumb" src="./images/${i.img}" alt="">
        <div>${i.title}</div>
      </div>
      <div class="qtyline">
        <button class="qbtn" data-id="${i.id}" data-act="dec">‚àí</button>
        <span class="count">${i.qty}</span>
        <button class="qbtn" data-id="${i.id}" data-act="inc">+</button>
      </div>
      <div style="min-width:90px;text-align:right">${formatPrice(i.amount)}</div>
    </div>`).join("");

  // –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫
  requestAnimationFrame(()=>{
    document.querySelectorAll('.cart-row').forEach(r=> r.classList.add('enter'));
  });

  listEl.querySelectorAll('.qbtn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const id=e.currentTarget.dataset.id;
      const act=e.currentTarget.dataset.act;
      if(act==='inc'){
        cart[id]=(cart[id]||0)+1;
        save(); renderCheckout(); updateCartUI();
      } else {
        // –µ—Å–ª–∏ —É–¥–∞–ª—è–µ–º –¥–æ 0 ‚Äî –∞–Ω–∏–º–∏—Ä—É–µ–º –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
        if ((cart[id]||0) <= 1){
          const row = listEl.querySelector(`.cart-row[data-id="${id}"]`);
          if (row){
            row.classList.add('removing');
            setTimeout(()=>{
              delete cart[id];
              save(); renderCheckout(); updateCartUI();
            }, 220);
          } else {
            delete cart[id];
            save(); renderCheckout(); updateCartUI();
          }
        } else {
          cart[id]-=1;
          save(); renderCheckout(); updateCartUI();
        }
      }
    });
  });

  const subtotal=payload.total;
  const fee=calcDelivery(subtotal);
  const total=subtotal+fee;

  document.getElementById('subtotalText').textContent=formatPrice(subtotal);
  const feeEl = document.getElementById('feeText');
  const freeNote = document.getElementById('freeNote');
  const method = document.getElementById('deliveryMethod').value;
  if (method==='delivery' && subtotal>=DELIVERY.freeFrom){
    feeEl.textContent = "0 ‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)";
    freeNote.textContent = `–ë–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç ${DELIVERY.freeFrom.toLocaleString('ru-RU')} ‚ÇΩ`;
  } else if (method==='delivery') {
    feeEl.textContent = formatPrice(fee);
    freeNote.textContent = `–ë–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç ${DELIVERY.freeFrom.toLocaleString('ru-RU')} ‚ÇΩ`;
  } else {
    feeEl.textContent = "0 ‚ÇΩ";
    freeNote.textContent = "";
  }
  document.getElementById('totalText').textContent=formatPrice(total);
}

function showCheckout(){
  if(Object.keys(cart).length===0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");
  document.getElementById('view-catalog').classList.remove('active');
  document.getElementById('view-checkout').classList.add('active');
  renderCheckout();
}

function showCatalog(){
  document.getElementById('view-checkout').classList.remove('active');
  document.getElementById('view-catalog').classList.add('active');
  renderCatalog();
  updateCartUI();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ FAB + Telegram MainButton
function updateCartUI(){
  const payload = buildPayload();
  const items = payload.items.reduce((s,i)=>s+i.qty,0);
  const total = payload.total;

  if (tg){
    if (items>0){
      tg.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ (${items}) ‚Ä¢ ${total.toLocaleString('ru-RU')} ‚ÇΩ`).show();
    } else {
      tg.MainButton.hide();
    }
  }

  const fab = document.getElementById('fabCart');
  const fabCount = document.getElementById('fabCount');
  const fabTotal = document.getElementById('fabTotal');
  if (items>0){
    fabCount.textContent = String(items);
    fabTotal.textContent = `${total.toLocaleString('ru-RU')} ‚ÇΩ`;
    fab.style.display = 'inline-flex';
  } else {
    fab.style.display = 'none';
  }
}

/* ====== –û—Ç–ø—Ä–∞–≤–∫–∞ ====== */
async function sendOrder(){
  const payload=buildPayload();
  if(!payload.items.length) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");

  const method=document.getElementById('deliveryMethod').value;
  const fee=calcDelivery(payload.total);

  const samePerson=document.getElementById('samePerson').checked;

  const form={
    customerName: document.getElementById('customerName').value.trim(),
    customerPhone: document.getElementById('customerPhone').value.trim(),
    recipientName: document.getElementById('recipientName').value.trim(),
    recipientPhone: document.getElementById('recipientPhone').value.trim(),
    address: document.getElementById('address').value.trim(),
    date: document.getElementById('date').value,
    time: document.getElementById('timeSlot').selectedOptions[0]?.textContent || '',
    timeStart: document.getElementById('timeSlot').value || '',
    comment: document.getElementById('comment').value.trim(),
    pickupPoint: document.getElementById('pickupPoint').value
  };

  if(!form.customerName) return alert("–£–∫–∞–∂–∏—Ç–µ –∏–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞");
  if(!isPhoneValid(form.customerPhone)) return alert("–¢–µ–ª–µ—Ñ–æ–Ω –∑–∞–∫–∞–∑—á–∏–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 (XXX) XXX-XX-XX");
  if(!form.date) return alert("–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É");
  if(!form.timeStart) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å–ª–æ—Ç");

  if(!samePerson){
    if(!form.recipientName) return alert("–£–∫–∞–∂–∏—Ç–µ –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è");
    if(!isPhoneValid(form.recipientPhone)) return alert("–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 (XXX) XXX-XX-XX");
  } else {
    form.recipientName=form.customerName;
    form.recipientPhone=form.customerPhone;
  }

  if(method==='delivery'){
    if(!form.address) return alert("–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏");
    if(!addressValid){
      addressValid = await geocodeValidate(form.address);
      if(addressValid) form.address = lastGeocodedAddress||form.address;
    }
    if(!addressValid) return alert("–ê–¥—Ä–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≥. –¢—é–º–µ–Ω—å –∏–ª–∏ –¢—é–º–µ–Ω—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞");
  }

  // –î–æ–ø.–ø—Ä–æ–≤–µ—Ä–∫–∞: –Ω–∞—á–∞–ª–æ —Å–ª–æ—Ç–∞ –º–∏–Ω–∏–º—É–º —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞
  const now = new Date();
  const minStartTs = new Date(now.getTime()+2*60*60*1000);
  const slotStart = new Date(`${form.date}T${form.timeStart}:00`);
  if (slotStart < minStartTs){
    return alert("–ù–∞—á–∞–ª–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–ª–æ—Ç–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞");
  }

  const items=payload.items.map(i=>({
    name:i.title,
    price:i.price.toLocaleString('ru-RU')+' ‚ÇΩ',
    qty:i.qty
  }));

  const body={
    customer:{ name:form.customerName, phone:phoneDigits(form.customerPhone) },
    recipient:{ name:form.recipientName, phone:phoneDigits(form.recipientPhone) },
    deliveryMethod:method,
    pickupPoint:form.pickupPoint,
    address:form.address,
    date:form.date,
    time:form.time,          // —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ "HH:MM‚ÄìHH:MM"
    comment:form.comment,
    items,
    source:'–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
    total:payload.total,
    fee,
    timePlaced:new Date().toISOString()
  };

  const resp=await fetch('/api/sendOrder',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  const json=await resp.json().catch(()=>({}));
  if(resp.ok&&json.ok){
    alert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
    for(const k in cart) delete cart[k];
    save();
    updateCartUI();
    showCatalog();
  } else {
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞");
  }
}
</script>
</body>
</html>
