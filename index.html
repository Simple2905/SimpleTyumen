<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–æ–ª–ª–µ–∫—Ü–∏—è –∫ 1 —Å–µ–Ω—Ç—è–±—Ä—è</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã Suggest -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=41cc1bdf-35fa-4959-ae88-6493220031f0&lang=ru_RU&suggest_apikey=41cc1bdf-35fa-4959-ae88-6493220031f0" type="text/javascript"></script>
  <style>
    :root { --pad:16px; --brand:#6b8f52; --muted:#e2e5ea; --shadow:0 8px 24px rgba(0,0,0,.08); }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Arial,Segoe UI,Roboto,sans-serif;background:#f6f7fb;color:#111}
    header{position:sticky;top:0;background:#fff;z-index:30;box-shadow:var(--shadow)}
    .strip{padding:10px var(--pad);text-align:center;font-weight:700;color:#fff;
           background:linear-gradient(90deg,#ef4444,#f97316,#f59e0b,#22c55e,#3b82f6,#8b5cf6);
           background-size:200% 100%; animation:slide 12s linear infinite;}
    @keyframes slide{0%{background-position:0% 0}100%{background-position:100% 0}}
    .head{display:flex;justify-content:space-between;align-items:center;padding:8px var(--pad);}
    .sub{font-weight:500;opacity:.9}
    .timer{font-size:14px;color:#d32f2f;font-weight:700}
    .wrap{max-width:1024px;margin:0 auto;padding:var(--pad)}
    .view{display:none} .view.active{display:block}
    .sort{display:flex;justify-content:flex-end;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    select,input,textarea{padding:10px;border:1px solid var(--muted);border-radius:10px;width:100%}
    .ghost{background:#fff;border:1px solid var(--muted);color:#111;border-radius:12px;padding:10px 12px;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
    @media(min-width:740px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{background:#fff;border-radius:20px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column;animation:fadeInUp .45s ease both}
    .imgbox{position:relative;aspect-ratio:3/4;background:#eee;overflow:hidden}
    .imgbox img{width:100%;height:100%;object-fit:cover;object-position:center top;display:block}
    .info{padding:12px}
    .title{font-weight:600;margin:0 0 6px;line-height:1.25}
    .price{font-size:15px;margin-bottom:10px;opacity:.9}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{flex:1;padding:12px;border-radius:12px;border:none;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
    .pill{padding:6px 10px;border-radius:999px;background:#f0f2f6;font-size:12px;margin-left:6px}
    footer{text-align:center;color:#777;padding:40px 0}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
    .checkout-card{background:#fff;border-radius:20px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;justify-content:space-between;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap}
    .field{flex:1;min-width:200px;display:flex;flex-direction:column;gap:4px;margin-bottom:12px}
    .note{font-size:12px;color:#666}
    .muted{color:#666;font-size:14px}
    .total{font-weight:700;font-size:18px}
    .qtyline{display:flex;gap:8px;align-items:center}
    .qbtn{width:28px;height:28px;border-radius:8px;border:1px solid var(--muted);background:#fff;cursor:pointer}
    .count{width:24px;text-align:center;display:inline-block}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="strip">–ö–æ–ª–ª–µ–∫—Ü–∏—è –∫ 1 —Å–µ–Ω—Ç—è–±—Ä—è</div>
    <div class="head">
      <div class="sub">–î–∞—Ä–∏—Ç—å —Ü–≤–µ—Ç—ã ‚Äî –ø—Ä–æ—Å—Ç–æ üå∏</div>
      <div id="timer" class="timer"></div>
    </div>
  </header>

  <div class="wrap">
    <!-- CATALOG -->
    <section id="view-catalog" class="view active">
      <div class="sort">
        <label for="sortSel">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
        <select id="sortSel">
          <option value="default">–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
          <option value="asc">—Ü–µ–Ω–∞ ‚Üë</option>
          <option value="desc">—Ü–µ–Ω–∞ ‚Üì</option>
        </select>
        <button id="goCheckout" class="ghost">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
      </div>
      <div id="grid" class="grid"></div>
    </section>

    <!-- CHECKOUT -->
    <section id="view-checkout" class="view">
      <div class="checkout-card">
        <div class="row">
          <div><b>–í–∞—à –∑–∞–∫–∞–∑</b> <span class="pill" id="cartCount">0 —Ç–æ–≤–∞—Ä–æ–≤</span></div>
          <button id="backToCatalog" class="ghost" style="min-width:120px">–ù–∞–∑–∞–¥</button>
        </div>
        <div id="orderList" class="muted"></div>

        <div class="row"><b>–ó–∞–∫–∞–∑—á–∏–∫</b></div>
        <div class="row">
          <div class="field"><label>–ò–º—è</label><input id="customerName" /></div>
          <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="customerPhone" /></div>
        </div>

        <div class="field"><label><input type="checkbox" id="samePerson" /> –ü–æ–ª—É—á–∞—Ç–µ–ª—å = –ó–∞–∫–∞–∑—á–∏–∫</label></div>

        <div id="recipientFields">
          <div class="row"><b>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</b></div>
          <div class="row">
            <div class="field"><label>–ò–º—è</label><input id="recipientName" /></div>
            <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="recipientPhone" /></div>
          </div>
        </div>

        <div class="field">
          <label>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</label>
          <select id="deliveryMethod">
            <option value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑</option>
            <option value="delivery">–î–æ—Å—Ç–∞–≤–∫–∞</option>
          </select>
        </div>

        <div id="pickupWrap" class="field">
          <label>–¢–æ—á–∫–∞ —Å–∞–º–æ–≤—ã–≤–æ–∑–∞</label>
          <select id="pickupPoint">
            <option value="polevaya">–ü–æ–ª–µ–≤–∞—è, 109—Å9</option>
            <option value="burlaki">–ë—É—Ä–ª–∞–∫–∏, 2–∞–∫3</option>
          </select>
        </div>

        <div id="addrWrap" class="field hidden">
          <label>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
          <input id="address" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å..." />
          <div class="note">–ê–≤—Ç–æ–ø–æ–∏—Å–∫ –ø–æ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞–º</div>
        </div>

        <div class="row">
          <div class="field"><label>–î–∞—Ç–∞</label><input id="date" type="date" /></div>
          <div class="field"><label>–í—Ä–µ–º—è</label><input id="time" type="time" /></div>
        </div>

        <div class="field"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea id="comment" rows="3"></textarea></div>
        <div class="row">
          <div class="total">–¢–æ–≤–∞—Ä—ã: <span id="subtotalText">0 ‚ÇΩ</span><br>–î–æ—Å—Ç–∞–≤–∫–∞: <span id="feeText">0 ‚ÇΩ</span><br>–ò—Ç–æ–≥–æ: <span id="totalText">0 ‚ÇΩ</span></div>
          <button id="sendOrder" class="btn" style="min-width:200px">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
      </div>
    </section>

    <footer>üïò –ü–Ω‚Äì–í—Å 08:30‚Äì21:00 ‚Ä¢ üõµ –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –¢—é–º–µ–Ω–∏</footer>
  </div>

<script>
const DELIVERY = { 
  byZone: { city: 200, suburb: 350, far: 500 }, 
  freeFrom: 4000, 
  defaultZone: 'city' 
};
let PRODUCTS = [];
fetch('./products.json').then(r => r.json()).then(list => { PRODUCTS = list; init(); })
  .catch(_ => { PRODUCTS = []; init(); });

const tg = window.Telegram?.WebApp; if (tg) tg.expand();
const cart = JSON.parse(sessionStorage.getItem('cart')||'{}');

function save(){ sessionStorage.setItem('cart', JSON.stringify(cart)); }
function formatPrice(n){ return n.toLocaleString('ru-RU') + ' ‚ÇΩ'; }

// --- –Ø–Ω–¥–µ–∫—Å –∞–¥—Ä–µ—Å: —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---
let addressValid = false;
let lastGeocodedAddress = "";
function geocodeValidate(address){
  return new Promise((resolve)=>{
    if (!window.ymaps || !address) return resolve(false);
    ymaps.geocode(address, { results: 1 }).then(res=>{
      if (res.geoObjects.getLength() > 0){
        const obj = res.geoObjects.get(0);
        const line = obj.getAddressLine();
        const parts = obj.getLocalities().join(' ') + " " + obj.getAdministrativeAreas().join(' ');
        // —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –¢—é–º–µ–Ω—å –∏ –¢—é–º–µ–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω
        const allowed = /–¢—é–º–µ–Ω—å/i.test(parts) || /–¢—é–º–µ–Ω—Å–∫/i.test(parts);
        if (allowed){
          lastGeocodedAddress = line;
          return resolve(true);
        }
      }
      resolve(false);
    }).catch(()=> resolve(false));
  });
}

function init(){
  document.getElementById('goCheckout').onclick = showCheckout;
  document.getElementById('backToCatalog').onclick = showCatalog;
  document.getElementById('sendOrder').onclick = sendOrder;
  document.getElementById('sortSel').addEventListener('change', renderCatalog);

  // –ß–µ–∫–±–æ–∫—Å ¬´–ü–æ–ª—É—á–∞—Ç–µ–ª—å = –ó–∞–∫–∞–∑—á–∏–∫¬ª
  document.getElementById('samePerson').addEventListener('change', e=>{
    if(e.target.checked){
      document.getElementById('recipientName').value=document.getElementById('customerName').value;
      document.getElementById('recipientPhone').value=document.getElementById('customerPhone').value;
      document.getElementById('recipientFields').style.display='none';
    } else {
      document.getElementById('recipientFields').style.display='block';
    }
  });

  // –∞–¥—Ä–µ—Å
  const methodSel = document.getElementById('deliveryMethod');
  const addrWrap  = document.getElementById('addrWrap');
  methodSel.addEventListener('change', ()=>{
    if (methodSel.value === 'delivery') addrWrap.classList.remove('hidden');
    else addrWrap.classList.add('hidden');
    renderCheckout();
  });

  if (window.ymaps) {
    ymaps.ready(()=>{
      const suggest = new ymaps.SuggestView('address');
      suggest.events.add('select', async (e)=>{
        const val = e.get('item')?.value || document.getElementById('address').value;
        addressValid = await geocodeValidate(val);
        if (addressValid) document.getElementById('address').value = lastGeocodedAddress || val;
      });
    });
  }
  document.getElementById('address').addEventListener('input', ()=>{ addressValid=false; });

  renderCatalog();
  renderCheckout();
}

function renderCatalog(){
  const grid = document.getElementById('grid');
  let list = PRODUCTS.slice();
  const sortSel = document.getElementById('sortSel')?.value || 'default';

  // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
  list.sort((a,b)=>{
    const pa = Number(a.price.toString().replace(/\D/g,''))||0;
    const pb = Number(b.price.toString().replace(/\D/g,''))||0;
    if (sortSel==='asc') return pa-pb;
    if (sortSel==='desc') return pb-pa;
    return 0;
  });

  grid.innerHTML = '';
  list.forEach(p=>{
    const qty = cart[p.id]||0;
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <div class="imgbox"><img src="./images/${p.img}" alt=""></div>
      <div class="info">
        <div class="title">${p.title}</div>
        <div class="price">${formatPrice(Number(p.price.toString().replace(/\D/g,'')))}</div>
        <div class="controls"><button class="btn add" data-id="${p.id}">–í –∫–æ—Ä–∑–∏–Ω—É ${qty>0?`<span class="pill">${qty}</span>`:''}</button></div>
      </div>`;
    el.querySelector('.add').onclick = e=>{
      const id=e.currentTarget.dataset.id;
      cart[id]=(cart[id]||0)+1;
      save();
      renderCatalog();
      if (document.getElementById('view-checkout').classList.contains('active')) renderCheckout();
    };
    grid.appendChild(el);
  });
}

function buildPayload(){
  const items = Object.entries(cart).map(([id,qty])=>{
    const p = PRODUCTS.find(x=>x.id===id);
    const priceNum = Number(p.price.toString().replace(/\D/g,''))||0;
    return {id,title:p.title,price:priceNum,qty,amount:priceNum*qty};
  });
  const total = items.reduce((s,i)=>s+i.amount,0);
  return {items,total};
}

function calcDelivery(subtotal){
  const method = document.getElementById('deliveryMethod').value;
  if (method==='pickup') return 0;
  if (subtotal >= DELIVERY.freeFrom) return 0;
  return DELIVERY.byZone.city;
}

function renderCheckout(){
  const payload = buildPayload();
  document.getElementById('cartCount').textContent = payload.items.length+" —Ç–æ–≤–∞—Ä(–∞)";

  const listEl=document.getElementById('orderList');
  listEl.innerHTML=payload.items.map(i=>`
    <div class="row">
      <div style="flex:1">${i.title}</div>
      <div class="qtyline">
        <button class="qbtn" data-id="${i.id}" data-act="dec">‚àí</button>
        <span class="count">${i.qty}</span>
        <button class="qbtn" data-id="${i.id}" data-act="inc">+</button>
      </div>
      <div style="min-width:90px;text-align:right">${formatPrice(i.amount)}</div>
    </div>`).join("");
  listEl.querySelectorAll('.qbtn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const id=e.currentTarget.dataset.id;
      const act=e.currentTarget.dataset.act;
      if(act==='inc') cart[id]=(cart[id]||0)+1;
      else { if((cart[id]||0)>1) cart[id]-=1; else delete cart[id]; }
      save(); renderCheckout();
    });
  });

  const subtotal=payload.total;
  const fee=calcDelivery(subtotal);
  const total=subtotal+fee;

  document.getElementById('subtotalText').textContent=formatPrice(subtotal);
  document.getElementById('feeText').textContent = 
    (document.getElementById('deliveryMethod').value==='delivery' && subtotal>=DELIVERY.freeFrom)
    ? `0 ‚ÇΩ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ç ${DELIVERY.freeFrom.toLocaleString('ru-RU')} ‚ÇΩ)` 
    : formatPrice(fee);
  document.getElementById('totalText').textContent=formatPrice(total);
}

function showCheckout(){
  if(Object.keys(cart).length===0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");
  document.getElementById('view-catalog').classList.remove('active');
  document.getElementById('view-checkout').classList.add('active');
  renderCheckout();
}

function showCatalog(){
  document.getElementById('view-checkout').classList.remove('active');
  document.getElementById('view-catalog').classList.add('active');
}

// --- –æ—Ç–ø—Ä–∞–≤–∫–∞ ---
async function sendOrder(){
  const payload=buildPayload();
  if(!payload.items.length) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");

  const method=document.getElementById('deliveryMethod').value;
  const fee=calcDelivery(payload.total);

  const samePerson=document.getElementById('samePerson').checked;

  const form={
    customerName: document.getElementById('customerName').value.trim(),
    customerPhone: document.getElementById('customerPhone').value.trim(),
    recipientName: document.getElementById('recipientName').value.trim(),
    recipientPhone: document.getElementById('recipientPhone').value.trim(),
    address: document.getElementById('address').value.trim(),
    date: document.getElementById('date').value,
    time: document.getElementById('time').value,
    comment: document.getElementById('comment').value.trim(),
    pickupPoint: document.getElementById('pickupPoint').value
  };

  if(!form.customerName) return alert("–£–∫–∞–∂–∏—Ç–µ –∏–º—è –∑–∞–∫–∞–∑—á–∏–∫–∞");
  if(!form.customerPhone) return alert("–£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∑–∞–∫–∞–∑—á–∏–∫–∞");
  if(!form.date) return alert("–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É");
  if(!form.time) return alert("–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è");

  if(!samePerson){
    if(!form.recipientName) return alert("–£–∫–∞–∂–∏—Ç–µ –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è");
    if(!form.recipientPhone) return alert("–£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è");
  } else {
    form.recipientName=form.customerName;
    form.recipientPhone=form.customerPhone;
  }

  if(method==='delivery'){
    if(!form.address) return alert("–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏");
    if(!addressValid){
      addressValid = await geocodeValidate(form.address);
      if(addressValid) form.address = lastGeocodedAddress||form.address;
    }
    if(!addressValid) return alert("–ê–¥—Ä–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≥. –¢—é–º–µ–Ω—å –∏–ª–∏ –¢—é–º–µ–Ω—Å–∫–æ–≥–æ —Ä–∞–π–æ–Ω–∞");
  }

  // –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
  const now=new Date();
  const chosen=new Date(form.date+"T"+form.time);
  const minTime=new Date(now.getTime()+2*60*60*1000);
  if(chosen<minTime) return alert("–í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞");

  // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º
  const [hh,mm]=form.time.split(":").map(Number);
  const mins=hh*60+mm;
  if(method==='delivery'){
    const start=9*60+30, end=21*60+30;
    if(mins<start||mins>end) return alert("–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Å 09:30 –¥–æ 21:30");
  } else {
    const start=8*60+30, end=21*60;
    if(mins<start||mins>end) return alert("–°–∞–º–æ–≤—ã–≤–æ–∑ –¥–æ—Å—Ç—É–ø–µ–Ω —Å 08:30 –¥–æ 21:00");
  }

  const items=payload.items.map(i=>({
    name:i.title,
    price:i.price.toLocaleString('ru-RU')+' ‚ÇΩ',
    qty:i.qty
  }));

  const body={
    customer:{ name:form.customerName, phone:form.customerPhone },
    recipient:{ name:form.recipientName, phone:form.recipientPhone },
    deliveryMethod:method,
    pickupPoint:form.pickupPoint,
    address:form.address,
    date:form.date,
    time:form.time,
    comment:form.comment,
    items,
    source:'–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
    total:payload.total,
    fee,
    timePlaced:new Date().toISOString()
  };

  const resp=await fetch('/api/sendOrder',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  const json=await resp.json().catch(()=>({}));
  if(resp.ok&&json.ok){
    alert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
    for(const k in cart) delete cart[k];
    save();
    showCatalog();
  } else {
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞");
  }
}
</script>




</body>
</html>
