<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Simple — Онлайн-витрина</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#fff;--fg:#111;--muted:#666;--brand:#111;--ok:#0a7f4f;--err:#b00020;--br:#e9e9e9
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;color:var(--fg);background:var(--bg)}
    header{padding:16px 20px;border-bottom:1px solid var(--br);display:flex;align-items:center;justify-content:space-between}
    .title{font-weight:700}
    .health{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:50%;background:#bbb}
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--err)}

    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{border:1px solid var(--br);border-radius:14px;overflow:hidden;background:#fff;display:flex;flex-direction:column}
    .thumb{aspect-ratio:1/1;object-fit:cover;width:100%;display:block}
    .card .box{padding:12px;display:flex;flex-direction:column;gap:6px}
    .name{font-weight:600}
    .price{color:var(--fg)}
    .muted{color:var(--muted);font-size:14px}
    .btn{appearance:none;border:none;background:var(--brand);color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:default}
    .btn.outline{background:#fff;color:var(--fg);border:1px solid var(--br)}
    .controls{display:flex;gap:8px;align-items:center}
    .footer-note{margin-top:18px;font-size:14px;color:var(--muted)}

    /* Modal */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.3);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{width:100%;max-width:520px;background:#fff;border-radius:16px;border:1px solid var(--br);overflow:hidden}
    .modal .head{padding:12px 14px;border-bottom:1px solid var(--br);display:flex;justify-content:space-between;align-items:center}
    .modal .body{padding:14px}
    .x{background:transparent;border:none;font-size:22px;line-height:1;cursor:pointer;color:var(--muted)}

    .row{margin-bottom:10px}
    .row label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px}
    .inp, .ta{width:100%;padding:10px;border:1px solid var(--br);border-radius:10px;font:inherit}
    .two{display:flex;gap:8px}
    .msg{margin-top:10px;font-size:14px}
    .msg.ok{color:var(--ok)} .msg.err{color:var(--err)}

    @media (hover:hover){
      .card:hover{box-shadow:0 6px 18px rgba(0,0,0,.06)}
    }
  </style>
</head>
<body>
  <header>
    <div class="title">Студия флористики «Симпл» — витрина</div>
    <div class="health">
      <span class="dot" id="healthDot"></span>
      <button class="btn outline" id="healthBtn">Проверить функции</button>
    </div>
  </header>

  <div class="wrap">
    <h2 style="margin:0 0 14px;">Популярное</h2>
    <div id="grid" class="grid"></div>
    <div class="footer-note">Нажмите «Купить», заполните контакты — заказ прилетит во внутреннюю группу Telegram.</div>
  </div>

  <!-- MODAL -->
  <div class="modal-back" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="head">
        <strong>Оформление заказа</strong>
        <button class="x" id="closeModal" aria-label="Закрыть">×</button>
      </div>
      <div class="body">
        <form id="orderForm" novalidate>
          <div class="row">
            <label>Товар</label>
            <input class="inp" name="productName" id="productName" type="text" required>
          </div>

          <div class="two row">
            <div style="flex:2">
              <label>Цена</label>
              <input class="inp" name="productPrice" id="productPrice" type="text" required>
            </div>
            <div style="flex:1">
              <label>Кол-во</label>
              <input class="inp" name="qty" id="qty" type="number" min="1" value="1" required>
            </div>
          </div>

          <div class="two row">
            <div style="flex:1">
              <label>Имя</label>
              <input class="inp" name="name" id="name" type="text" required placeholder="Ваше имя">
            </div>
            <div style="flex:1">
              <label>Телефон</label>
              <input class="inp" name="phone" id="phone" type="tel" required placeholder="+7 900 000-00-00">
            </div>
          </div>

          <div class="row">
            <label>Адрес (необязательно)</label>
            <input class="inp" name="address" id="address" type="text" placeholder="г. Тюмень, ул. ...">
          </div>

          <div class="row">
            <label>Комментарий (необязательно)</label>
            <textarea class="ta" name="comment" id="comment" rows="3" placeholder="Пожелания к заказу"></textarea>
          </div>

          <div class="row controls">
            <button class="btn" id="submitBtn" type="submit">Отправить заказ</button>
            <button class="btn outline" id="cancelBtn" type="button">Отмена</button>
          </div>
          <div class="msg" id="orderMsg"></div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ====== ДАННЫЕ ВИТРИНЫ (замени пути на свои изображения) ======
    const PRODUCTS = [
      { id:'p1', name:'Букет «1 сентября»', price:'2 990 ₽', img:'images/bouquet-01.jpg' },
      { id:'p2', name:'Пионы и матрикария', price:'4 490 ₽', img:'images/bouquet-02.jpg' },
      { id:'p3', name:'Композиция в коробке', price:'5 990 ₽', img:'images/bouquet-03.jpg' },
      { id:'p4', name:'Монобукет роз', price:'3 590 ₽', img:'images/bouquet-04.jpg' }
    ];

    // ====== ОТРИСОВКА КАРТОЧЕК ======
    const gridEl = document.getElementById('grid');
    function renderGrid(){
      gridEl.innerHTML = PRODUCTS.map(p => `
        <article class="card">
          <img class="thumb" alt="${escapeHtml(p.name)}" src="${p.img}">
          <div class="box">
            <div class="name">${escapeHtml(p.name)}</div>
            <div class="price">${escapeHtml(p.price)}</div>
            <div class="muted">В наличии</div>
            <div class="controls">
              <button class="btn" data-buy="${p.id}">Купить</button>
              <button class="btn outline" data-info="${p.id}">Подробнее</button>
            </div>
          </div>
        </article>
      `).join('');
    }

    // Простой эскейп для названий
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

    // ====== МОДАЛКА ======
    const modalBack = document.getElementById('modalBack');
    const closeModalBtn = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    function openModal(){ modalBack.style.display = 'flex'; }
    function closeModal(){ modalBack.style.display = 'none'; resetFormStatus(); }

    closeModalBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modalBack.addEventListener('click', (e)=>{ if (e.target === modalBack) closeModal(); });

    // ====== ПОДСТАНОВКА ТОВАРА В ФОРМУ ======
    const f = {
      productName: document.getElementById('productName'),
      productPrice: document.getElementById('productPrice'),
      qty: document.getElementById('qty'),
      name: document.getElementById('name'),
      phone: document.getElementById('phone'),
      address: document.getElementById('address'),
      comment: document.getElementById('comment'),
      msg: document.getElementById('orderMsg'),
      btn: document.getElementById('submitBtn'),
      form: document.getElementById('orderForm'),
    };

    function fillProduct(p){
      f.productName.value = p.name;
      f.productPrice.value = p.price;
      f.qty.value = 1;
      openModal();
    }

    // ====== ЛОГИКА КНОПОК НА КАРТОЧКАХ ======
    gridEl.addEventListener('click', (e)=>{
      const buyId = e.target.closest('[data-buy]')?.dataset.buy;
      const infoId = e.target.closest('[data-info]')?.dataset.info;
      if (buyId){
        const p = PRODUCTS.find(x => x.id === buyId);
        if (p) fillProduct(p);
      } else if (infoId){
        const p = PRODUCTS.find(x => x.id === infoId);
        if (p) alert(`${p.name}\nЦена: ${p.price}\n\nКороткое описание товара.`);
      }
    });

    // ====== ОТПРАВКА В NETLIFY FUNCTION ======
    async function apiSendOrder(payload){
      const resp = await fetch('/api/sendOrder', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload),
      });
      if (!resp.ok){
        const t = await resp.text().catch(()=> '');
        throw new Error(t || ('HTTP ' + resp.status));
      }
      const json = await resp.json().catch(()=> ({}));
      if (!json.ok){ throw new Error(json.error || 'Не удалось отправить заказ'); }
      return json;
    }

    function setFormStatus(text, type){ // type: 'ok' | 'err'
      f.msg.textContent = text || '';
      f.msg.className = 'msg ' + (type || '');
    }
    function resetFormStatus(){ setFormStatus('', ''); }

    f.form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      resetFormStatus();
      f.btn.disabled = true; f.btn.textContent = 'Отправляем...';

      const payload = {
        name: (f.name.value || '').trim(),
        phone: (f.phone.value || '').trim(),
        address: (f.address.value || '').trim(),
        comment: (f.comment.value || '').trim(),
        product: {
          name: (f.productName.value || '').trim(),
          price: (f.productPrice.value || '').trim(),
          qty: Number(f.qty.value || 1)
        },
        source: 'Каталог',
        time: new Date().toISOString(),
        meta: { userAgent: navigator.userAgent }
      };

      try{
        await apiSendOrder(payload);
        setFormStatus('✅ Заказ отправлен! Мы свяжемся с вами в ближайшее время.', 'ok');
        f.form.reset();
        // Можно закрыть модалку через пару секунд:
        setTimeout(closeModal, 900);
      }catch(err){
        console.error(err);
        setFormStatus('❌ Ошибка отправки: ' + (err.message || 'попробуйте ещё раз'), 'err');
      }finally{
        f.btn.disabled = false; f.btn.textContent = 'Отправить заказ';
      }
    });

    // ====== ПРОВЕРКА ФУНКЦИЙ (/.netlify/functions/health через редирект /api/health) ======
    const healthBtn = document.getElementById('healthBtn');
    const healthDot = document.getElementById('healthDot');

    async function checkHealth(){
      healthBtn.disabled = true;
      healthDot.className = 'dot';
      try{
        const r = await fetch('/api/health', { cache: 'no-store' });
        const j = await r.json().catch(()=> ({}));
        if (r.ok && j.ok){
          healthDot.classList.add('ok');
          healthBtn.textContent = 'OK';
        }else{
          healthDot.classList.add('err');
          healthBtn.textContent = 'Ошибка';
        }
      }catch(e){
        healthDot.classList.add('err');
        healthBtn.textContent = 'Сеть/ошибка';
      }finally{
        setTimeout(()=>{ healthBtn.disabled = false; }, 600);
      }
    }

    healthBtn.addEventListener('click', checkHealth);

    // ====== ИНИЦ ======
    renderGrid();
    // Можешь сразу проверять функции при загрузке:
    // checkHealth();
  </script>
</body>
</html>
